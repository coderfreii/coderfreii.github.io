##### 前言

​		学习go语言主要是在逛github的时候不少有趣的项目使用golang写的，这是一个学习动机，一番学习下来，发现golang适合写一些工具，不是很适合写抽象化更高的东西，这是因为golang没有真正的继承，无法实现父类调用子类方法，总之为了练习的目的写了下面这个下载工具。

​	注: 习惯用线程这个词了，下文出现的线程即代表协程

###### 基本原理

​		该项目主要是想实现一个多线程的下载工具，原理利用http协议实现的 partial download （分部下载）

因为每个http服务器的协议实现情况不一样需要目标服务器本身支持

​		分部下载的基本原理就是客户端在向服务器发送下载请求时，在请求头里附带需要下载的文件分片

```
Range bytes=0-100
```

​		上面的请求头代表向服务器请求当前文件的0-100个字节

​		在此原理上便可实现 断点续传和多线程下载，本项目主要包含多线程下载的内容

###### 主要流程逻辑

+ 获取下载文件的大小
+ 根据设置的线程数将文件分为均等份（最后一份大小随动）拼接出上述所说的请求头
+ 利用该请求头开启等量线程去执行下载
+ 等下载完毕后，合并为一个文件（一般要进行文件校验和，但是这个很依赖服务器的具体实现，就暂且不做该功能）



###### 一些附加的便利性功能。

+ 显示下载速率和进度

​		本来只是想练手写个用得到的工具，但是下载文件如果没有下载速率和下载进度是绝对不能容忍的，故而添加了该功能，该功能有两个版本，第一版秉持着先写出来，怎么简单怎么来的想法，只能显示的平均速率， 写完之后还是觉得用起来怪怪的不符合直觉，故而有了第二个版本，显示实时下载速度，即前一秒的下载速度。

+ 可添加http代理

​		这个主要是依托于原生的golang的http库实现的，虽然很简单，但是很能解决一些痛点。

+ 重试机制

  ​	该工具还做了简单的重试机制如果有一线程在下载的过程中连接断开了，进行重试，因为不是断点续传，没有持久化功能， 所以这个仅限于一次下载的过程中， 在我测试使用的时候没有遇到断开的情况故而，也就意味着该逻辑还没执行过所以可能会有一点点bug，但是如果不是网络环境特别差就不影响使用。



###### 遇到的一点小问题

+ 重定向问题导致文件名称不对，和不必要的多次重定向

  解决方法golang支持添加重定向的监听器，在里面更新下载信息即可

+ UI和下载线程结束顺序问题

​		原本的逻辑是UI的线程，要等待所有下载线程完成就会退出，同时主线程是要等待所有下载线程完成就会继续运行。这可能会导致UI线程来不及完成最后一个循环，主线程就退出了，导致UI显示不会到达百分之百。

​		为了解决这个问题意味者主线程不仅需要等待下载线程全部完成，也要等待UI线程完成，UI线程内判断所有下载线程是否完成，如果完成则进行最后一次刷新。

​		但是这样就需要两个sync.WaitGroup 解决这个问题，这样显得有点臃肿。 对其进行简单的包装改造，使其能显示未完成的线程的数量即可，UI线程判断是否只剩一个线程未完成，即自身线程，然后进行最后一次刷新随即退出即可。

​		

​	该工具代码量不大，具体代码片段就不贴出来了，项目的地址如下：

[coderfreii/httpdownloader: a simple downloader speed up for http/https download by partial download (github.com)](https://github.com/coderfreii/httpdownloader)